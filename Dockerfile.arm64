FROM --platform=linux/amd64 conblem/rust-aarch64-unknown-linux-musl:main as builder

WORKDIR /app
COPY Cargo.toml Cargo.lock /app/

COPY fake.rs src/main.rs
RUN RUSTFLAGS='--cfg tokio_unstable' cargo build --release --target=aarch64-unknown-linux-musl

COPY src src
RUN touch src/main.rs
RUN RUSTFLAGS='--cfg tokio_unstable' cargo build --release --target=aarch64-unknown-linux-musl

FROM scratch
WORKDIR /app

COPY --from=builder /app/target/aarch64-unknown-linux-musl/release/sniproxy /app/arm64